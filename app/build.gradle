apply plugin: 'com.android.application'

android {
    compileSdkVersion 23
    buildToolsVersion "21.1.2"
    useLibrary 'org.apache.http.legacy'
    defaultConfig {
        applicationId "nu.yona.app"
        minSdkVersion 14
        targetSdkVersion 23
        versionCode 1
        versionName "1.0.0"
    }
    buildTypes {
        release {
            minifyEnabled false
            proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-rules.pro'
        }
    }

    testOptions {
        //this keeps junit (without robolectric) from failing when calling Log.<whatever> or TextUtils.<whatever>
        unitTests.returnDefaultValues = true
    }

    compileOptions {
        sourceCompatibility JavaVersion.VERSION_1_7
        targetCompatibility JavaVersion.VERSION_1_7
    }

    packagingOptions {
        exclude 'META-INF/ASL2.0'
        exclude 'META-INF/LICENSE'
        exclude 'META-INF/NOTICE'
    }

    applicationVariants.all { variant ->
        variant.outputs.each { output ->
            def apk = output.outputFile
            def appName = getAppName()
            def branch = getBranch().replaceAll(/\//, "-")
            def versionString = getVersionString()
            def buildNumber = getBuildNumber()
            def apkName = appName + '-' + branch + '-' + versionString + '.' + buildNumber

            if (variant.buildType.name == "release")
                apkName += "-RELEASE"

            output.outputFile = new File(apk.parent, apkName + '.apk')
            output.packageApplication.outputFile = new File(apk.parent, apkName + '-unaligned.apk')
        }
    }

    productFlavors {
        //build flavors:
        zdev {
            //do nothing here, just merge in custom res
        }
        zproduction {
            //do nothing here, just merge in custom res
        }

    }

    buildTypes {
        release {
            minifyEnabled false
            proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-rules.pro'
        }
    }
    android.defaultConfig.versionName = getVersionString()
    android.defaultConfig.versionCode = Integer.valueOf(getBuildNumber())

    lintOptions {
        abortOnError false
    }
}

def getAppName() {
    def appName
    if ('APP_NAME' in project.ext.properties) {
        appName = project.ext.properties['APP_NAME']
    } else {
        appName = "Yona"
    }
}

def getBuildNumber() {
    def buildNumber

    if ('BUILD_NUMBER' in project.ext.properties) {
        buildNumber = project.ext.properties['BUILD_NUMBER']
    } else {
        buildNumber = "1"
    }
    return buildNumber
}

def getVersionString() {
    def versionString

    if ('VERSION_STRING' in project.ext.properties) {
        versionString = project.ext.properties['VERSION_STRING']
    } else {
        versionString = android.defaultConfig.versionName ?: "0.0.0"
    }
    return versionString
}


def getBranch() {
    def branch

    if ('BRANCH' in project.ext.properties) {
        branch = project.ext.properties['BRANCH']
    } else {
        branch = "develop"
    }

    return branch
}

dependencies {
    compile fileTree(dir: 'libs', include: ['*.jar'])
    compile 'com.android.support:appcompat-v7:23.1.1'
    compile 'com.android.support:design:23.1.1'
    compile 'com.squareup.retrofit2:retrofit:2.0.0'
    compile 'com.squareup.okhttp3:okhttp:3.2.0'
    compile 'com.google.code.gson:gson:2.4'
    compile 'com.squareup.retrofit2:converter-gson:2.0.0'
    testCompile 'junit:junit:4.12'
    testCompile('org.robolectric:robolectric:3.0')

}
